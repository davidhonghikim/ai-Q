{
  "metadata": {
    "sub_recipe_id": "02-04-self-hosted-services",
    "title": "Docker Infrastructure for Self-Hosted Services",
    "version": "1.0.0",
    "created_by": "Claude Sonnet 4",
    "last_updated": "2025-01-30T23:58:00Z",
    "purpose": "Establish Docker infrastructure foundation for self-hosted services - networks, volumes, and orchestration framework",
    "total_tasks": 3,
    "estimated_duration": "30 minutes",
    "complexity": "Intermediate",
    "dependencies": ["02-01-docker-core", "02-02-docker-services", "02-03-ai-ml-services"],
    "port_assignments": {
      "self_hosted_network": "ai-q-self-hosted-network",
      "self_hosted_volumes": ["ai-q-self-hosted-data", "ai-q-self-hosted-config", "ai-q-self-hosted-db"],
      "notes": "Infrastructure only - actual services installed by specialized recipes"
    }
  },
  "prerequisites": {
    "completed_tasks": [
      "02-01-01: Docker environment setup",
      "02-01-02: Network architecture configured",
      "02-01-03: Volume management setup",
      "02-02-01: Docker services orchestration",
      "02-03-01: AI/ML network created",
      "02-03-02: AI/ML volumes created"
    ],
    "system_requirements": {
      "cpu": "Minimum 2 cores for self-hosted infrastructure",
      "ram": "Minimum 4GB for self-hosted infrastructure",
      "storage": "Minimum 100GB for self-hosted data and databases",
      "network": "Stable internet connection for future service installations"
    }
  },
  "task_01_create_self_hosted_network": {
    "task_id": "02-04-01",
    "title": "Create Self-Hosted Services Network",
    "description": "Create dedicated Docker network for self-hosted services",
    "estimated_duration": "5 minutes",
    "critical": true,
    "steps": [
      {
        "step_id": "02-04-01-01",
        "title": "Create self-hosted network",
        "description": "Create dedicated network for self-hosted services",
        "commands": [
          "docker network create --driver bridge --subnet 172.21.0.0/16 --gateway 172.21.0.1 ai-q-self-hosted-network",
          "docker network ls --filter name=ai-q-self-hosted-network"
        ],
        "verification": "Check network created",
        "expected_output": "ai-q-self-hosted-network network created and listed"
      }
    ],
    "verification_commands": [
      "docker network ls --filter name=ai-q-self-hosted-network",
      "docker network inspect ai-q-self-hosted-network --format '{{.IPAM.Config}}'"
    ],
    "expected_outputs": {
      "network_exists": "ai-q-self-hosted-network in network list",
      "subnet_correct": "Subnet: 172.21.0.0/16, Gateway: 172.21.0.1"
    }
  },
  "task_02_create_self_hosted_volumes": {
    "task_id": "02-04-02",
    "title": "Create Self-Hosted Data Volumes",
    "description": "Create persistent volumes for self-hosted services data",
    "estimated_duration": "10 minutes",
    "critical": true,
    "steps": [
      {
        "step_id": "02-04-02-01",
        "title": "Create self-hosted data volumes",
        "description": "Create volumes for self-hosted services data storage",
        "commands": [
          "docker volume create ai-q-self-hosted-data",
          "docker volume create ai-q-self-hosted-config",
          "docker volume create ai-q-self-hosted-db",
          "docker volume create ai-q-self-hosted-cache",
          "docker volume create ai-q-self-hosted-backups"
        ],
        "verification": "Check volumes created",
        "expected_output": "All self-hosted volumes created successfully"
      },
      {
        "step_id": "02-04-02-02",
        "title": "Set volume permissions",
        "description": "Set appropriate permissions for self-hosted volumes",
        "commands": [
          "sudo chown -R 1000:1000 /var/lib/docker/volumes/ai-q-self-hosted-*/_data",
          "sudo chmod -R 755 /var/lib/docker/volumes/ai-q-self-hosted-*/_data"
        ],
        "verification": "Check permissions set",
        "expected_output": "Volume permissions set correctly"
      }
    ],
    "verification_commands": [
      "docker volume ls --filter name=ai-q-self-hosted",
      "ls -la /var/lib/docker/volumes/ai-q-self-hosted-*/_data"
    ],
    "expected_outputs": {
      "volumes_exist": "All ai-q-self-hosted volumes listed",
      "permissions_correct": "Volumes owned by user 1000:1000"
    }
  },
  "task_03_create_self_hosted_orchestration": {
    "task_id": "02-04-03",
    "title": "Create Self-Hosted Orchestration Framework",
    "description": "Create Docker Compose templates and orchestration framework for self-hosted services",
    "estimated_duration": "15 minutes",
    "critical": true,
    "steps": [
      {
        "step_id": "02-04-03-01",
        "title": "Create self-hosted orchestration directory",
        "description": "Create directory structure for self-hosted orchestration",
        "commands": [
          "sudo mkdir -p /opt/ai-q/docker/compose/self-hosted",
          "sudo mkdir -p /opt/ai-q/docker/compose/self-hosted/templates",
          "sudo mkdir -p /opt/ai-q/docker/compose/self-hosted/configs",
          "sudo mkdir -p /opt/ai-q/docker/compose/self-hosted/databases"
        ],
        "verification": "Check directories created",
        "expected_output": "Self-hosted orchestration directories created"
      },
      {
        "step_id": "02-04-03-02",
        "title": "Create base self-hosted Docker Compose template",
        "description": "Create base template for self-hosted services",
        "config_file": "/opt/ai-q/docker/compose/self-hosted/templates/base-self-hosted.yml",
        "config_content": {
          "version": "3.8",
          "networks": {
            "ai-q-self-hosted-network": {
              "external": true
            }
          },
          "volumes": {
            "self-hosted-data": {
              "external": true
            },
            "self-hosted-config": {
              "external": true
            },
            "self-hosted-db": {
              "external": true
            },
            "self-hosted-cache": {
              "external": true
            },
            "self-hosted-backups": {
              "external": true
            }
          }
        },
        "commands": [
          "sudo tee /opt/ai-q/docker/compose/self-hosted/templates/base-self-hosted.yml << 'EOF'\nversion: '3.8'\n\nnetworks:\n  ai-q-self-hosted-network:\n    external: true\n\nvolumes:\n  self-hosted-data:\n    external: true\n  self-hosted-config:\n    external: true\n  self-hosted-db:\n    external: true\n  self-hosted-cache:\n    external: true\n  self-hosted-backups:\n    external: true\nEOF"
        ],
        "verification": "Check template created",
        "expected_output": "Base self-hosted template created"
      },
      {
        "step_id": "02-04-03-03",
        "title": "Create self-hosted orchestration script",
        "description": "Create orchestration script for self-hosted services",
        "config_file": "/opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh",
        "config_content": {
          "script_purpose": "Orchestrate self-hosted services using Docker Compose",
          "functions": [
            "start_self_hosted_service(service_name)",
            "stop_self_hosted_service(service_name)",
            "restart_self_hosted_service(service_name)",
            "check_self_hosted_service_status(service_name)",
            "backup_self_hosted_data(service_name)"
          ]
        },
        "commands": [
          "sudo tee /opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh << 'EOF'\n#!/bin/bash\n\n# Self-Hosted Services Orchestration Script\n# This script provides functions for managing self-hosted services\n\nSELF_HOSTED_DIR=\"/opt/ai-q/docker/compose/self-hosted\"\n\nstart_self_hosted_service() {\n    local service_name=\$1\n    local compose_file=\"\$SELF_HOSTED_DIR/\${service_name}.yml\"\n    \n    if [ -f \"\$compose_file\" ]; then\n        echo \"Starting \$service_name...\"\n        docker-compose -f \"\$compose_file\" up -d\n    else\n        echo \"Error: \$compose_file not found\"\n        return 1\n    fi\n}\n\nstop_self_hosted_service() {\n    local service_name=\$1\n    local compose_file=\"\$SELF_HOSTED_DIR/\${service_name}.yml\"\n    \n    if [ -f \"\$compose_file\" ]; then\n        echo \"Stopping \$service_name...\"\n        docker-compose -f \"\$compose_file\" down\n    else\n        echo \"Error: \$compose_file not found\"\n        return 1\n    fi\n}\n\nrestart_self_hosted_service() {\n    local service_name=\$1\n    stop_self_hosted_service \"\$service_name\"\n    sleep 5\n    start_self_hosted_service \"\$service_name\"\n}\n\ncheck_self_hosted_service_status() {\n    local service_name=\$1\n    local compose_file=\"\$SELF_HOSTED_DIR/\${service_name}.yml\"\n    \n    if [ -f \"\$compose_file\" ]; then\n        echo \"Checking status of \$service_name...\"\n        docker-compose -f \"\$compose_file\" ps\n    else\n        echo \"Error: \$compose_file not found\"\n        return 1\n    fi\n}\n\nbackup_self_hosted_data() {\n    local service_name=\$1\n    local backup_dir=\"/opt/ai-q/backups/self-hosted/\${service_name}\"\n    local timestamp=\$(date +%Y%m%d_%H%M%S)\n    \n    echo \"Creating backup for \$service_name...\"\n    sudo mkdir -p \"\$backup_dir\"\n    \n    # Backup volumes\n    docker run --rm -v ai-q-self-hosted-data:/data -v \"\$backup_dir\":/backup alpine tar czf /backup/\${service_name}_\${timestamp}.tar.gz -C /data .\n    \n    echo \"Backup created: \${backup_dir}/\${service_name}_\${timestamp}.tar.gz\"\n}\n\n# Main script logic\ncase \"\$1\" in\n    start)\n        start_self_hosted_service \"\$2\"\n        ;;\n    stop)\n        stop_self_hosted_service \"\$2\"\n        ;;\n    restart)\n        restart_self_hosted_service \"\$2\"\n        ;;\n    status)\n        check_self_hosted_service_status \"\$2\"\n        ;;\n    backup)\n        backup_self_hosted_data \"\$2\"\n        ;;\n    *)\n        echo \"Usage: \$0 {start|stop|restart|status|backup} <service_name>\"\n        exit 1\n        ;;\nesac\nEOF",
          "sudo chmod +x /opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh"
        ],
        "verification": "Check script created and executable",
        "expected_output": "Self-hosted orchestration script created and executable"
      }
    ],
    "verification_commands": [
      "ls -la /opt/ai-q/docker/compose/self-hosted/",
      "cat /opt/ai-q/docker/compose/self-hosted/templates/base-self-hosted.yml",
      "/opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh --help"
    ],
    "expected_outputs": {
      "directory_structure": "self-hosted directory with templates and configs",
      "base_template": "Base self-hosted template with networks and volumes",
      "orchestration_script": "Orchestration script is executable"
    }
  },
  "acceptance_criteria": {
    "infrastructure_ready": [
      "ai-q-self-hosted-network Docker network exists and is configured",
      "All self-hosted volumes (data, config, db, cache, backups) created and accessible",
      "Self-hosted orchestration directory structure created",
      "Base self-hosted Docker Compose template available",
      "Self-hosted orchestration script created and executable"
    ],
    "no_services_installed": [
      "No actual self-hosted services (Gitea, NextCloud, PostgreSQL, etc.) are installed",
      "Only infrastructure foundation is established",
      "Ready for specialized recipes to install actual services"
    ],
    "integration_ready": [
      "Network can be used by other self-hosted service recipes",
      "Volumes can be mounted by other self-hosted service recipes",
      "Orchestration framework ready for service management"
    ]
  },
  "deliverables": {
    "infrastructure_components": [
      "Docker network: ai-q-self-hosted-network (172.21.0.0/16)",
      "Docker volumes: ai-q-self-hosted-data, ai-q-self-hosted-config, ai-q-self-hosted-db, ai-q-self-hosted-cache, ai-q-self-hosted-backups",
      "Orchestration directory: /opt/ai-q/docker/compose/self-hosted/",
      "Base template: /opt/ai-q/docker/compose/self-hosted/templates/base-self-hosted.yml",
      "Orchestration script: /opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh"
    ],
    "documentation": [
      "Self-hosted infrastructure setup complete",
      "Ready for specialized recipes to install actual services",
      "Orchestration framework available for service management"
    ]
  },
  "troubleshooting_guide": {
    "network_creation_failed": {
      "issue": "Docker network creation fails",
      "solution": "Check if network already exists: docker network ls | grep ai-q-self-hosted-network",
      "commands": [
        "docker network rm ai-q-self-hosted-network",
        "docker network create --driver bridge --subnet 172.21.0.0/16 --gateway 172.21.0.1 ai-q-self-hosted-network"
      ]
    },
    "volume_permissions_error": {
      "issue": "Volume permissions not set correctly",
      "solution": "Check Docker daemon user and set correct permissions",
      "commands": [
        "sudo chown -R 1000:1000 /var/lib/docker/volumes/ai-q-self-hosted-*/_data",
        "sudo chmod -R 755 /var/lib/docker/volumes/ai-q-self-hosted-*/_data"
      ]
    },
    "orchestration_script_not_executable": {
      "issue": "Orchestration script not executable",
      "solution": "Set executable permissions on the script",
      "commands": [
        "sudo chmod +x /opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh",
        "ls -la /opt/ai-q/docker/compose/self-hosted/orchestrate-self-hosted.sh"
      ]
    }
  },
  "performance_benchmarks": {
    "network_creation": "Docker network creation completes within 5 seconds",
    "volume_creation": "All volumes created within 10 seconds",
    "orchestration_setup": "Complete orchestration framework setup within 30 seconds",
    "script_execution": "Orchestration script responds within 2 seconds"
  },
  "next_steps": {
    "immediate": "Infrastructure ready for specialized self-hosted service recipes",
    "future": "Specialized recipes will install actual self-hosted services using this infrastructure",
    "integration": "Services will use ai-q-self-hosted-network and mounted volumes"
  }
} 